const calendar = document.getElementById('calendar');
const monthYear = document.getElementById('month-year');
const taskPopup = document.getElementById('task-popup');
const popupDate = document.getElementById('popup-date');
const taskList = document.getElementById('task-list');
const taskForm = document.getElementById('task-form');
const taskInput = document.getElementById('task-input');
const closePopupBtn = document.getElementById('close-popup');

const prevMonthBtn = document.getElementById('prev-month');
const nextMonthBtn = document.getElementById('next-month');

let currentDate = new Date();
let tasks = {}; // Store tasks keyed by date string "YYYY-MM-DD"
let selectedDate = null;

function formatDate(date) {
    return date.toISOString().split('T')[0]; // YYYY-MM-DD
}

function renderCalendar() {
    calendar.innerHTML = '';

    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();

    // Show current month and year
    const options = {
        month: 'long',
        year: 'numeric'
    };
    monthYear.textContent = currentDate.toLocaleDateString(undefined, options);

    // Get first day of month and number of days
    const firstDay = new Date(year, month, 1).getDay(); // 0 (Sun) - 6 (Sat)
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    // Add empty slots for days before 1st
    for (let i = 0; i < firstDay; i++) {
        const emptyCell = document.createElement('div');
        calendar.appendChild(emptyCell);
    }

    // Add day cells
    for (let day = 1; day <= daysInMonth; day++) {
        const dayDiv = document.createElement('div');
        dayDiv.classList.add('day');
        const dateStr = `${year}-${String(month + 1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        dayDiv.textContent = day;

        // Add pin if tasks exist
        if (tasks[dateStr] && tasks[dateStr].length > 0) {
            dayDiv.classList.add('has-task');
        }

        // Click day to open popup
        dayDiv.addEventListener('click', () => openTaskPopup(dateStr, dayDiv));
        calendar.appendChild(dayDiv);
    }
}

function openTaskPopup(dateStr, dayDiv) {
    selectedDate = dateStr;
    popupDate.textContent = `Tasks for ${dateStr}`;
    taskList.innerHTML = '';

    const dayTasks = tasks[dateStr] || [];
    dayTasks.forEach(task => {
        const li = document.createElement('li');
        li.textContent = task;
        taskList.appendChild(li);
    });

    taskPopup.classList.remove('hidden');
}

taskForm.addEventListener('submit', e => {
    e.preventDefault();
    const newTask = taskInput.value.trim();
    if (!newTask) return;

    if (!tasks[selectedDate]) {
        tasks[selectedDate] = [];
    }
    tasks[selectedDate].push(newTask);

    taskInput.value = '';
    openTaskPopup(selectedDate);
    renderCalendar(); // Update pins
});

closePopupBtn.addEventListener('click', () => {
    taskPopup.classList.add('hidden');
});

// Change month buttons
prevMonthBtn.addEventListener('click', () => {
    currentDate.setMonth(currentDate.getMonth() - 1);
    renderCalendar();
});

nextMonthBtn.addEventListener('click', () => {
    currentDate.setMonth(currentDate.getMonth() + 1);
    renderCalendar();
});

// Initial render
renderCalendar();
